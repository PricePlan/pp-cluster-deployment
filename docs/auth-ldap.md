## Подключение аутентификации/авторизации средствами AD

Мы будем исходить из предположения, что у вас уже имеется лес Active Directory,
в котором существет, как минимум, один домен, например, example.com. Также
уже настроены и доступны 2 контроллера домена, разрешение доменных имён на
нодах кластера функционирует, необходимые сетевые ресурсы доступны.

Для того, чтобы означенный механим заработал, нам потребуется запустить
плэйбук, но сначала необходимо произвести несложную подготовку и настройку.

### 1. Создание пользователя, групп и распределение ролей

Чтобы система могла получать данные из AD об имеющихся группах, пользователях
и их членстве необходимо создать специального служебного пользователя, от имени
которого PricePlan будет выполнять LDAP-запросы.

В основном домене (в нашем примере dc=example,dc=com) следует создать группу
ou=priceplan. Внутри неё нужно создать ещё 3 группы (приведём distinguished
names):

* cn=superusers,ou=priceplan,dc=example,dc=com

* cn=Менеджеры,ou=priceplan,dc=example,dc=com

* cn=disabled,ou=priceplan,dc=example,dc=com

При добавлении пользователя в группу *superusers* он будет иметь возможность
входить в PricePlan с правами администратора. Аналогичным образом пользователь
из группы *Менеджеры* получит соответствующие привилегии.

В группу *disabled* имеет смысл поместить какого-то пользователя, уже
находящегося в одной из выше перечисленных групп, чтобы временно запретить ему
доступ в систему.

### 2. Получение сертификата

Поскольку взаимодействие между PricePlan и AD будет происходить по протоколу
LDAP с шифрованием передаваемых данных, нам потребуется сертификат контроллера
домена.

Чтобы убедиться, что мы имеем в виду один и тот же сертификат, поясним, каким
способом можно получить гарантированно рабочий сертификат. Зайдите броузером
на http://имя_вашего_контроллера/certsrv/certcarc.asp, установите encoding
method в соответствие со значением «Base 64». Кликните на ссылку
«Download CA certificate». Полученный сертификат поместите в директорию
files/ssl данного проекта.

### 3. Настройка плэйбука

Из файла группы *pp_cluster.yaml.example* скопируйте в ваш рабочий файл код,
расположенный ниже строки с комментарием «# LDAP».

Укажите необходимые значения как минимум для переменных:

* ldap_CA_cert

* ldap_server_uri_1

* ldap_bind_dn_1

* ldap_bind_password_1

* ldap_server_uri_2

* ldap_bind_dn_2

* ldap_bind_password_2

* ldap_base_dn

В завершение установите *ldap_enabled* в значение true.

### 4. Запуск плэйбука

Обновление состояния кластера производится стандартной командой:

```bash
$ time ansible-playbook playbooks/pp-cluster.yaml -t pp,settings -l pp_cluster
```
